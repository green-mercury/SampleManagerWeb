name: Docker build

on:
  # NOTE: This event will only trigger a workflow run if the workflow file is on the default branch.
  # https://docs.github.com/en/actions/reference/events-that-trigger-workflows#workflow_run
  workflow_run:
    workflows: [Build base]
    types: 
      - completed

jobs:
  # based on https://stackoverflow.com/a/64373702
  build-docker:
    name: Build docker image & run tests
    runs-on: ubuntu-latest
    env:
      COMPOSE_FILE: docker/docker-compose.yml

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # c.f. https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#using-data-from-the-triggering-workflow
    - name: Download app-static
      uses: actions/github-script@v6
      with:
        script: |
          let allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
          });
          let matchArtifact = allArtifacts.data.artifacts.filter((artifact) => {
            return artifact.name == 'app-static'
          })[0];
          let download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: matchArtifact.id,
              archive_format: 'zip',
          });
          let fs = require('fs');
          fs.writeFileSync(`${process.env.GITHUB_WORKSPACE}/app-static.zip`, Buffer.from(download.data));

    - name: Unzip artifact
      run: unzip -o app-static.zip -d app/static

    - name: Build docker images
      run: docker compose build web

    - name: Run tests
      run: docker compose run web python -m pytest

  push-docker:
    if: github.event_name == 'push'
    name: Push docker image
    runs-on: ubuntu-latest
    env:
      COMPOSE_FILE: docker/docker-compose.yml

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Build docker images
      run: docker-compose build web

    - name: Login to ghcr
      run: echo ${{ github.token }} | docker login ghcr.io -u hgrf --password-stdin

    - name: Push to ghcr
      run: docker push ghcr.io/hgrf/racine:latest

    - name: Push to ghcr (tagged)
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        sed s'/refs\/tags\///g' <(echo "${{ github.ref }}") | (read TAG; \
          docker tag ghcr.io/hgrf/racine:latest \
                     ghcr.io/hgrf/racine:$TAG &&  \
          docker push ghcr.io/hgrf/racine:$TAG && \
          echo Successfully pushed ghcr.io/hgrf/racine:$TAG
        )

